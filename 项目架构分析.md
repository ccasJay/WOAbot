## 📊 **WOAbot项目架构与工作逻辑详解**

这是一个**基于Next.js的自动化内容生产与发布系统**，核心功能是**从Perplexity AI获取最新资讯并自动发布到微信公众号**，具备完整的配置管理、定时调度和状态跟踪能力。


---

### 🛠️ **技术栈选型**
| 技术/服务 | 用途 | 版本 |
|---------|-----|-----|
| **Next.js** | 全栈框架（前端+API） | 16.0.7 |
| **React** | 前端UI框架 | 19 |
| **TypeScript** | 类型安全开发 | 5 |
| **GitHub Actions** | 定时任务与工作流自动化 | - |
| **GitHub API** | 配置与历史数据存储 | - |
| **Perplexity API** | AI内容生成 | - |
| **WeChat API** | 微信公众号发布 | - |


---

### 📁 **核心目录结构**
```
/
├── src/
│   ├── app/              # Next.js App Router 路由
│   │   ├── api/          # API 端点
│   │   ├── dashboard/    # 后台管理界面
│   │   ├── login/        # 登录页面
│   │   └── layout.tsx    # 全局布局
│   ├── components/       # UI 组件
│   ├── lib/              # 核心业务逻辑
│   │   ├── auth.ts       # 认证
│   │   ├── content.ts    # 内容生成与处理
│   │   ├── github.ts     # GitHub 数据存储
│   │   ├── perplexity.ts # Perplexity AI 客户端
│   │   ├── scheduler.ts  # 定时调度
│   │   └── wechat.ts     # 微信API客户端
│   ├── types/            # TypeScript 类型定义
│   └── middleware.ts     # 中间件
├── config/               # 配置文件模板
├── data/                 # 历史数据存储
├── scripts/              # 自动化脚本
├── .github/workflows/    # GitHub Actions 工作流
└── package.json          # 项目依赖
```


---

### 🔧 **核心模块详解**

#### 1. **调度器 (`src/lib/scheduler.ts`)**
**功能**：管理系统何时执行内容生成和发布任务
**核心函数**：
- `validateScheduleConfig()`: 验证调度配置的合法性
- `isValidExecutionDay()`: 判断当前日期是否为预设执行日
- `getNextExecutionTime()`: 计算下次执行时间（考虑时区）
- `generateCronExpression()`: 生成 GitHub Actions 可用的 Cron 表达式

**调度模式**：
- **每日模式**: 每天固定时间执行
- **间隔模式**: 每隔N天执行一次（1-30天）
- **每周模式**: 每周指定几天执行（如周一、周三、周五）

#### 2. **Perplexity AI 客户端 (`src/lib/perplexity.ts`)**
**功能**：与 Perplexity API 交互，生成文章内容
**特性**：
- 支持指数退避重试（5xx错误和429限流）
- 自动解析 API 响应为结构化数据
- API 密钥有效性验证
- 默认使用 `sonar` 模型

#### 3. **内容处理模块 (`src/lib/content.ts`)**
**功能**：将AI生成的内容转换为微信公众号可用的格式
**核心流程**：
1. **Prompt构建**: 生成专业的AI提示词，包含主题、格式要求和字数限制
2. **内容解析**: 从AI响应中提取标题、摘要和正文
3. **格式转换**: 将 Markdown 转换为微信兼容的 HTML
4. **内容验证**: 确保文章符合字数（1500-2500字）和结构要求
5. **状态管理**: 跟踪文章状态（生成中→已生成→已推送→推送失败）

#### 4. **GitHub 客户端 (`src/lib/github.ts`)**
**功能**：将配置和历史数据存储在 GitHub 仓库中

**存储内容**：
- `config/topics.json`: 配置要生成的主题
- `config/settings.json`: 系统设置（调度、内容格式）
- `data/history.json`: 文章历史记录和 API 用量统计

#### 5. **微信公众号客户端 (`src/lib/wechat.ts`)**
**功能**：与微信公众号平台交互，实现文章推送到草稿箱

**核心类**：`WeChatClient`

**API 端点**：
| 功能 | 端点 | 方法 |
|-----|------|-----|
| 获取 access_token | `/cgi-bin/token` | GET |
| 上传永久素材（封面图） | `/cgi-bin/material/add_material` | POST |
| 上传图文消息内图片 | `/cgi-bin/media/uploadimg` | POST |
| 创建草稿 | `/cgi-bin/draft/add` | POST |

**核心方法**：
- `getAccessToken()`: 获取并缓存 access_token（有效期 2 小时，提前 5 分钟刷新）
- `uploadImage()`: 上传永久素材作为文章封面，返回 `media_id`
- `uploadArticleImage()`: 上传图文消息内图片，将外部图片转为微信域名 URL
- `createDraft()`: 创建草稿，将文章推送到公众号草稿箱

**推送流程**：
```
┌─────────────────────────────────────────────────────────┐
│  1. 获取 access_token                                   │
│     GET /cgi-bin/token?appid=xxx&secret=xxx            │
│     → 返回 access_token（缓存 2 小时）                   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│  2. 上传封面图（永久素材）                               │
│     POST /cgi-bin/material/add_material                │
│     → 返回 media_id（用于 thumb_media_id）              │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│  3. 处理正文图片                                         │
│     - 提取 HTML 中的外部图片 URL                         │
│     - 逐个上传到微信服务器                               │
│     POST /cgi-bin/media/uploadimg                      │
│     → 返回微信域名 URL（mmbiz.qpic.cn）                  │
│     - 替换原文中的图片链接                               │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│  4. 创建草稿                                             │
│     POST /cgi-bin/draft/add                            │
│     Body: { articles: [{ title, content, digest,       │
│             thumb_media_id, ... }] }                   │
│     → 返回草稿 media_id                                 │
└─────────────────────────────────────────────────────────┘
```

**错误处理机制**：
- **40001 自动重试**：当 access_token 过期时，自动刷新并重试请求
- **错误码映射**：内置 40+ 种微信 API 错误码的中文描述
- **图片上传容错**：单张图片上传失败不中断整体流程，保留原 URL

**辅助函数**：
- `formatForWeChat()`: 将文章格式化为微信 API 所需格式
- `extractExternalImageUrls()`: 提取 HTML 中的外部图片 URL
- `isWeChatImageUrl()`: 判断 URL 是否为微信域名
- `replaceImageUrl()`: 替换 HTML 中的图片链接

#### 6. **自动化脚本 (`scripts/daily-publish.ts`)**
**功能**：由 GitHub Actions 触发的核心执行脚本
**执行流程**：
1. 验证环境变量
2. 读取配置和历史记录
3. 检查是否为有效执行日
4. 读取并筛选启用的主题
5. 调用 Perplexity API 生成内容
6. 转换为微信格式并推送
7. 更新历史记录并保存到 GitHub


---

### 🔄 **完整工作流程**
```
┌─────────────────────────────────────────────────────────┐
│                     GitHub Actions                     │
│  (定时触发：每天0点UTC → 北京时间8点)                    │
└─────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────┐
│  1. 运行脚本：scripts/daily-publish.ts                 │
└─────────────────────────────────────────────────────────┘
                                │
┌───────────────────────────────┴─────────────────────────┐
│  2. 读取配置                                             │
│     - settings.json (调度设置)                           │
│     - topics.json    (主题配置)                           │
└─────────────────────────────────────────────────────────┘
                                │
┌───────────────────────────────┴─────────────────────────┐
│  3. 检查执行条件                                         │
│     - 是否为有效执行日？                                 │
│     - 是否有启用的主题？                                 │
└─────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┴─────────────────────────┐
        │  4. 生成AI内容                                    │
        │     - 构建Prompt                                 │
        │     - 调用Perplexity API                         │
        │     - 处理响应内容                               │
        └─────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┴─────────────────────────┐
        │  5. 发布到微信公众号                              │
        │     - 获取微信access_token                       │
        │     - 创建微信草稿箱                              │
        │     - 更新文章状态                               │
        └─────────────────────────────────────────────────┘
                                │
┌───────────────────────────────┴─────────────────────────┐
│  6. 更新历史记录                                         │
│     - 保存文章信息到history.json                         │
│     - 统计API token用量和成本                           │
│     - 提交到GitHub仓库                                  │
└─────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────┐
│  7. 完成任务                                             │
└─────────────────────────────────────────────────────────┘
```


---

### ✨ **项目优势与最佳实践**

1. **无服务器架构**
   所有计算都在 GitHub Actions 中完成，无需自己维护服务器，降低了运维成本。

2. **时间 zone 支持**
   调度系统完全支持时区转换，确保在正确的时间执行任务。

3. **健壮的错误处理**
   - 所有外部 API 调用都有重试机制
   - 详细的日志记录
   - 文章状态跟踪，支持失败重试

4. **成本控制**
   - 内置 API token 用量统计
   - 每月预算限制和预警
   - 成本计算基于模型定价

5. **可扩展性**
   - 模块化设计，易于添加新功能
   - 支持多种内容来源和发布平台

6. **类型安全**
   全程使用 TypeScript，减少了运行时错误。


---

### 🎓 **学习亮点**

1. **Prompt 工程的应用**
   如何编写有效的提示词，让 AI 生成符合要求的内容。

2. **工作流自动化**
   如何使用 GitHub Actions 实现定时任务和自动化流程。

3. **API 客户端开发**
   如何构建健壮的 API 客户端，包含重试、错误处理和类型转换。

4. **状态管理**
   如何设计文章状态的流转逻辑（生成→推送→完成）。

5. **无服务器存储**
   如何利用 GitHub API 实现简单的数据存储。


---

### 📌 **总结**
这是一个**架构清晰、功能完整的自动化内容生产系统**，融合了现代 web 技术和 AI 能力。它展示了如何将不同的服务和技术整合在一起，构建出一个实用、可靠的自动化工具。如果需要深入了解某个具体模块或功能，欢迎随时提问！
# 需求文档

## 简介

本功能扩展现有的定时发布系统，允许用户自定义更灵活的任务调度频率。当前系统仅支持每天固定时间发布一篇文章，本功能将支持多种调度模式，包括每隔 N 天发布、每周指定日期发布、以及每天发布多篇文章等场景，以满足不同运营策略的需求。

## 术语表

- **调度频率**: 定义任务执行间隔的配置，包括执行周期和时间点
- **调度模式**: 预定义的调度类型，如每日、间隔天数、每周指定日期等
- **执行时间点**: 一天中任务执行的具体时间（小时:分钟）
- **间隔天数**: 两次任务执行之间相隔的天数
- **周执行日**: 每周中指定执行任务的星期几（1-7，1 为周一）
- **cron 表达式**: GitHub Actions 使用的定时任务表达式格式

## 需求列表

### 需求 1

**用户故事:** 作为公众号运营者，我希望能够设置每隔 N 天执行一次发布任务，以便根据内容产出节奏灵活安排发布频率。

#### 验收标准

1. WHEN 用户在设置页面选择"间隔天数"调度模式时，系统应显示天数输入框，允许输入 1-30 之间的整数
2. WHEN 用户保存间隔天数设置时，系统应将配置写入 `config/settings.json` 的 schedule.intervalDays 字段
3. WHEN 间隔天数设置生效时，系统应根据上次执行时间计算下次执行日期
4. WHEN 用户设置间隔天数为 1 时，系统应等同于每日执行模式

### 需求 2

**用户故事:** 作为公众号运营者，我希望能够选择每周的特定日期执行发布任务，以便配合固定的内容发布节奏。

#### 验收标准

1. WHEN 用户在设置页面选择"每周指定日期"调度模式时，系统应显示星期选择器，允许选择一个或多个星期几
2. WHEN 用户保存每周日期设置时，系统应将配置写入 `config/settings.json` 的 schedule.weekDays 字段（数组格式，1-7 表示周一到周日）
3. WHEN 每周日期设置生效时，系统应仅在选定的星期几执行任务
4. WHEN 用户未选择任何日期时，系统应阻止保存并显示错误提示

### 需求 3

**用户故事:** 作为公众号运营者，我希望能够设置每天的多个执行时间点，以便在一天内发布多篇文章。

#### 验收标准

1. WHEN 用户在设置页面添加执行时间点时，系统应允许添加最多 3 个不同的时间点
2. WHEN 用户保存多时间点设置时，系统应将配置写入 `config/settings.json` 的 schedule.executionTimes 字段（数组格式）
3. WHEN 多时间点设置生效时，系统应在每个指定时间点执行一次任务
4. WHEN 用户添加重复的时间点时，系统应阻止添加并显示错误提示

### 需求 4

**用户故事:** 作为公众号运营者，我希望系统能够根据调度配置自动生成对应的 GitHub Actions cron 表达式，以便无需手动编辑 workflow 文件。

#### 验收标准

1. WHEN 用户保存调度设置时，系统应根据配置生成对应的 cron 表达式
2. WHEN 生成 cron 表达式时，系统应正确处理时区转换（从用户配置的时区转换为 UTC）
3. WHEN 调度模式为"间隔天数"且天数大于 1 时，系统应生成每日执行的 cron，并在脚本中判断是否为执行日
4. WHEN 调度模式为"每周指定日期"时，系统应生成包含星期几的 cron 表达式

### 需求 5

**用户故事:** 作为公众号运营者，我希望在设置页面能够预览下次执行时间，以便确认调度配置是否正确。

#### 验收标准

1. WHEN 用户修改调度设置时，系统应实时显示下次执行的预计时间（用户时区）
2. WHEN 显示下次执行时间时，系统应同时显示对应的 UTC 时间
3. WHEN 调度配置无效时，系统应显示"无法计算"提示

### 需求 6

**用户故事:** 作为公众号运营者，我希望系统在执行任务前检查是否为有效执行日，以便间隔天数模式能正确工作。

#### 验收标准

1. WHEN GitHub Actions 触发任务时，脚本应首先检查当前日期是否为有效执行日
2. WHEN 当前日期不是有效执行日时，脚本应记录日志并正常退出，不执行内容生成
3. WHEN 当前日期是有效执行日时，脚本应继续执行正常的内容生成和推送流程
4. WHEN 检查执行日时，系统应读取 `data/history.json` 中的上次执行时间进行计算

